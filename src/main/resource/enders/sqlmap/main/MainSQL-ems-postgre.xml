<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.enders.ums.main.dao.MainMapper">

	<!-- 상단 메뉴 조회 -->
	<select id="getTopMenuList" parameterType="string" resultType="menuVO">
		SELECT A.PROG_ID, A.PROG_NM, A.PROG_TARGET
			 , A.PROG_DOMAIN, A.USE_YN, A.PROG_SCRIPT, A.UILANG
		  FROM NEO_PROG A
		 WHERE A.USE_YN = 'Y'
		   AND A.UILANG = #{uilang}
		 ORDER BY A.DISP_ORDER ASC, A.PROG_ID DESC
	</select>
	
	<!-- 메뉴 기본 정보 조회 -->
	<select id="getMenuBasicInfo" parameterType="string" resultType="sysMenuVO">
		SELECT MENU_NM
			 , SOURCE_PATH
		  FROM NEO_SYSMENU
		 WHERE MENU_ID = #{menuId}
	</select>
	
	<!-- 각 서비스 기본 화면에서 첫번째 메뉴 조회 -->
	<select id="getServiceUserMenu" parameterType="sysMenuVO" resultType="sysMenuVO">
		SELECT MENU_ID, MENU_NM, PARENTMENU_ID, SOURCE_PATH
		  FROM (
				SELECT ROW_NUMBER() OVER (ORDER BY T1.MENU_ID) SEQ<!-- SORT_SNO 대신 메뉴ID로 정렬함(메뉴 순서가 안바뀔듯)  -->
					 , T1.MENU_ID
					 , T1.MENU_NM
					 , T1.PARENTMENU_ID
					 , T1.SOURCE_PATH
				  FROM NEO_SYSMENU T1
					 , NEO_MENUUSER_MAPP T2
				 WHERE T1.MENU_ID = T2.MENU_ID
				   AND T2.USER_ID = #{userId}
				   AND T1.SERVICE_GB = #{serviceGb}
				   AND T1.SOURCE_PATH IS NOT NULL
				) TT
		 WHERE SEQ = 1
	</select>
	
	<!-- 시스템메뉴 정보에 등록된 URI인지 확인 -->
	<select id="getSourcePathMenu" parameterType="string" resultType="sysMenuVO">
		SELECT MENU_ID, MENU_NM, PARENTMENU_ID
		  FROM NEO_SYSMENU
		 WHERE SOURCE_PATH = #{sourcePath}
	</select>
	
	<!-- 메뉴에 대한 사용자 권한 확인 -->
	<select id="getUserMenuAuth" parameterType="sysMenuVO" resultType="sysMenuVO">
		SELECT T2.MENU_ID, T2.MENU_NM, T2.PARENTMENU_ID
		  FROM NEO_MENUUSER_MAPP T1, NEO_SYSMENU T2
		 WHERE T1.MENU_ID = T2.MENU_ID
		   AND T1.USER_ID = #{userId}
		   AND T2.SOURCE_PATH = #{sourcePath}
	</select>

	<!-- 서비스에 대한 사용자 권한 확인 -->
	<select id="getUserService" parameterType="string" resultType="serviceVO">
		SELECT A.SERVICE_GB
			 , (SELECT COUNT(*) FROM NEO_USER_PROG WHERE PROG_ID = A.SERVICE_GB AND USER_ID = #{userId}) USE_YN 
			 , CUST_DOMAIN
			 , SERVICE_NM 
			 , LICENSE_KEY
			 , 0 PAY_YN
		  FROM NEO_SERVICEKEY A
		 ORDER BY A.SERVICE_GB
	</select>
	
	<!-- EMS 메인화면 사용자 정보 -->
	<select id="getUserInfo" parameterType="emsMainVO" resultType="emsMainVO">
		SELECT T0.USER_ID
			 , T0.USER_NM 
			 , T1.ORG_CD 
			 , T2.ORG_KOR_NM 
			 , T1.JOB_GB 
			 , T3.CD_NM AS JOB_NM
		  FROM NEO_USER T0
  		INNER JOIN NEO_USERORG_MAPP T1 ON T0.USER_ID = T1.USER_ID
  		INNER JOIN V_NEO_ORGANIZATION T2 ON T1.ORG_CD = T2.ORG_CD 
  		INNER JOIN NEO_CD T3 ON T3.CD_GRP = 'C105' AND T1.JOB_GB = T3.CD AND T3.UILANG = '000'
 		WHERE T0.USER_ID = #{userId}
	</select>
	
	<!-- EMS 메인화면 결제 정보 -->
	<select id="getUserApprov" parameterType="emsMainVO" resultType="emsMainVO">
		SELECT SUM(TT1.CNT_202) AS CNT202
			 , SUM(TT1.CNT_203) AS CNT203
			 , SUM(TT1.CNT_204) AS CNT204
			 , MIN(TT1.MINDATE_202) AS MINDATE202
			 , MAX(TT1.MAXDATE_202) AS MAXDATE202
			 , MIN(TO_CHAR(NOW()::date + interval '-7 day','YYYYMMDD')) AS MINDATE2034
			 , MAX(TO_CHAR(NOW(),'YYYYMMDD')) AS MAXDATE2034
		FROM ( SELECT SUM(CASE WHEN T2.WORK_STATUS = '202' THEN 1 ELSE 0 END) AS CNT_202
					, SUM(CASE WHEN T2.WORK_STATUS = '203' THEN 1 ELSE 0 END) AS CNT_203
					, SUM(CASE WHEN T2.WORK_STATUS = '204' THEN 1 ELSE 0 END) AS CNT_204
					, MIN(CASE WHEN T2.WORK_STATUS = '202' THEN SUBSTR(T2.SEND_DT,1,8) END) AS MINDATE_202
					, MAX(CASE WHEN T2.WORK_STATUS = '202' THEN SUBSTR(T2.SEND_DT,1,8) END) AS MAXDATE_202 
				FROM NEO_SUBTASK T2  
				INNER JOIN NEO_TASK T1 ON T1.TASK_NO = T2.TASK_NO 
				WHERE COALESCE(T2.STATUS, '000') IN ('000','001')
				AND T2.WORK_STATUS IN ('202','203','204')
				AND (CASE WHEN T2.WORK_STATUS = '202' THEN 'Y' 
						  WHEN T2.WORK_STATUS IN ('203','204') 
						  AND T2.SEND_DT BETWEEN (TO_CHAR(NOW()::date + interval '-7 day' , 'YYYYMMDD') || '000000') AND (TO_CHAR(NOW(),'YYYYMMDD') || '235959') THEN 'Y'
					ELSE 'N' END) = 'Y'
				AND T2.WORK_STATUS IN ('202','203','204') 	
				AND T1.USER_ID = #{userId}
				AND T1.DEPT_NO = (SELECT COALESCE(MAX(DEPT_NO),-1) FROM NEO_USER WHERE USER_ID = #{userId})
				UNION ALL  
				SELECT SUM(CASE WHEN T2.WORK_STATUS = '202' THEN 1 ELSE 0 END) AS CNT_202
					 , SUM(CASE WHEN T2.WORK_STATUS = '203' THEN 1 ELSE 0 END) AS CNT_203
					 , SUM(CASE WHEN T2.WORK_STATUS = '204' THEN 1 ELSE 0 END) AS CNT_204
					 , MIN(CASE WHEN T2.WORK_STATUS = '202' THEN SUBSTR(T2.REG_DT,1,8) END) AS MINDATE_202
					 , MAX(CASE WHEN T2.WORK_STATUS = '202' THEN SUBSTR(T2.REG_DT,1,8) END) AS MAXDATE_202 
				  FROM TS_SERVICETYP T2 
				 WHERE COALESCE(T2.STATUS, '000') IN ('000','001')
				   AND T2.WORK_STATUS IN ('202','203','204')
			 	   AND (CASE WHEN T2.WORK_STATUS = '202' THEN 'Y' 
						  WHEN T2.WORK_STATUS IN ('203','204') 
						  AND T2.REG_DT BETWEEN (TO_CHAR(NOW()::date + interval '-7 day' , 'YYYYMMDD') || '000000') AND (TO_CHAR(NOW(),'YYYYMMDD') || '235959') THEN 'Y'
						ELSE 'N' END) = 'Y'
				   AND T2.USER_ID = #{userId}
				   AND T2.DEPT_NO = (SELECT COALESCE(MAX(DEPT_NO),-1) FROM NEO_USER WHERE USER_ID = #{userId})
			) TT1
	</select>
	
	<!-- EMS 메인화면 일별 총발송,발송성공,발송실패 -->
	<select id="getDayMailSummary" parameterType="emsMainVO" resultType="emsMainVO">
	<![CDATA[
		SELECT SUM(TT1.TOT) AS CNT_TOT     
			 , SUM(TT1.SUCC) AS CNT_SUCC   
			 , SUM(TT1.FAIL) AS CNT_FAIL   
		FROM ( SELECT SUM(SEND_AR_AMT) AS TOT  
					, SUM(CASE WHEN SEND_RCODE = '000' THEN SEND_AR_AMT ELSE 0 END) AS SUCC
					, SUM(CASE WHEN SEND_RCODE <> '000' THEN SEND_AR_AMT ELSE 0 END) AS FAIL
				FROM NEO_AR_SENDLOG A
				INNER JOIN NEO_SUBTASK B ON A.TASK_NO = B.TASK_NO AND A.SUB_TASK_NO = B.SUB_TASK_NO AND COALESCE(B.SEND_TEST_YN, 'N') <> 'Y'
				WHERE A.SEND_DT BETWEEN #{searchYmd} || '0000' AND #{searchYmd} || '2359'
				AND (A.DEPT_NO = (SELECT MAX(T2.DEPT_NO) FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId})
				OR 'Y' = (SELECT COALESCE(MAX(CASE WHEN T2.DEPT_NO = 1 THEN 'Y' ELSE T2.DATA_ALL_YN END), 'N')
							FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId} ) )
				UNION ALL
				SELECT COUNT(DISTINCT TO_CHAR(T1.MID, '00000000000000000009') || TO_CHAR(T1.SUBID, '00000000000000000009')  || T1.RID || T1.STIME ) AS TOT
					 , COUNT(DISTINCT CASE WHEN T1.RCODE = '1' THEN TO_CHAR(T1.MID, '00000000000000000009') || TO_CHAR(T1.SUBID, '00000000000000000009')  || T1.RID || T1.STIME END ) AS SUCC
					 , COUNT(DISTINCT CASE WHEN T1.RCODE != '1' THEN TO_CHAR(T1.MID, '00000000000000000009') || TO_CHAR(T1.SUBID, '00000000000000000009')  || T1.RID || T1.STIME END ) AS FAIL
				FROM TS_RESULTLOG T1
				INNER JOIN TS_MAILQUEUE T2 ON T1.MID = T2.MID AND T1.SUBID = T2.SUBID
				WHERE T1.STIME BETWEEN TO_CHAR(TO_DATE(#{searchYmd},'YYYYMMDD'),'YYYY/MM/DD HH24:MI:SS') AND TO_CHAR(TO_DATE(#{searchYmd} || '235959','YYYYMMDDHH24MISS'),'YYYY/MM/DD HH24:MI:SS')
				AND (T2.DEPT_NO = (SELECT MAX(T2.DEPT_NO) FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId})
				OR 'Y' = (SELECT COALESCE(MAX(CASE WHEN T2.DEPT_NO = 1 THEN 'Y' ELSE T2.DATA_ALL_YN END), 'N')
				FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId} ) )
			) TT1	
	]]>        
	</select>
	
	<!-- EMS 메인화면 일별 열람한 메일 -->
	<select id="getDayMailOpen" parameterType="emsMainVO" resultType="emsMainVO">	
	<![CDATA[
		SELECT SUM(TT1.OPN_TOT) AS OPN_TOT
  		FROM ( SELECT SUM(A.RESP_AR_AMT) AS OPN_TOT
				FROM NEO_AR_RESPLOG A
				INNER JOIN NEO_SUBTASK B ON A.TASK_NO = B.TASK_NO AND A.SUB_TASK_NO = B.SUB_TASK_NO AND COALESCE(B.SEND_TEST_YN, 'N') <> 'Y' 
				WHERE A.OPEN_DT BETWEEN #{searchYmd} || '0000' AND #{searchYmd} || '2359'
				AND (A.DEPT_NO = (SELECT MAX(T2.DEPT_NO) FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId})  
				OR 'Y' = (SELECT COALESCE(MAX(CASE WHEN T2.DEPT_NO = 1 THEN 'Y' ELSE T2.DATA_ALL_YN END), 'N') 
							FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId} ) )
				UNION ALL
				SELECT COUNT(DISTINCT TO_CHAR(T1.MID, '00000000000000000009') || TO_CHAR(T1.SUBID, '00000000000000000009')  || T1.RID ) AS OPN_TOT 
				FROM TS_RESPONSELOG T1
				INNER JOIN TS_MAILQUEUE T2 ON T1.MID = T2.MID AND T1.SUBID = T2.SUBID
				WHERE T1.RSDATE BETWEEN TO_CHAR(TO_DATE(#{searchYmd},'YYYYMMDD'),'YYYY/MM/DD HH24:MI:SS') AND TO_CHAR(TO_DATE(#{searchYmd} || '235959','YYYYMMDDHH24MISS'),'YYYY/MM/DD HH24:MI:SS')
				AND (T2.DEPT_NO = (SELECT MAX(T2.DEPT_NO) FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId})
				OR 'Y' = (SELECT COALESCE(MAX(CASE WHEN T2.DEPT_NO = 1 THEN 'Y' ELSE T2.DATA_ALL_YN END), 'N')
							FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId} ) )
			) TT1	
	]]>  		
	</select>
	
	<!-- EMS 메인화면 일별 세부에러 -->
	<select id="getDayMailDetailErr" parameterType="emsMainVO" resultType="emsMainVO">
	<![CDATA[
		SELECT TT1.SEND_RCODE
			 , TT2.CD_NM AS SEND_RCODE_NM 
			 , SUM(TT1.ERR_CNT) AS CNT_ERR
		FROM ( SELECT A.SEND_RCODE
					, COUNT(DISTINCT TO_CHAR(A.TASK_NO, '0000000000000000009') || TO_CHAR(A.SUB_TASK_NO , '0000000000000000009')) AS TASK_CNT
					, SUM(A.SEND_AR_AMT) AS ERR_CNT 
				FROM NEO_AR_SENDLOG A
				INNER JOIN NEO_SUBTASK B ON A.TASK_NO = B.TASK_NO AND A.SUB_TASK_NO = B.SUB_TASK_NO AND COALESCE(B.SEND_TEST_YN, 'N') <> 'Y'
				WHERE A.SEND_DT BETWEEN #{searchYmd} || '0000' AND #{searchYmd} || '2359'
				AND A.SEND_RCODE <> '000'
				AND (A.DEPT_NO = (SELECT MAX(T2.DEPT_NO) FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId})  
				OR 'Y' = (SELECT COALESCE(MAX(CASE WHEN T2.DEPT_NO = 1 THEN 'Y' ELSE T2.DATA_ALL_YN END), 'N') 
							FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId} ) )
				GROUP BY A.SEND_RCODE  
				UNION ALL
				SELECT T3.STEP1 AS SEND_RCODE
					 , COUNT(DISTINCT T1.TID) AS TASK_CNT
					 , COUNT(DISTINCT TO_CHAR(T1.MID, '00000000000000000009') || TO_CHAR(T1.SUBID, '00000000000000000009')  || T1.RID || T1.STIME ) AS ERR_CNT 
				FROM TS_RESULTLOG T1
				INNER JOIN TS_MAILQUEUE T2 ON T1.MID = T2.MID AND T1.SUBID = T2.SUBID
				INNER JOIN TS_RCODE T3 ON T1.RCODE = T3.RCODE 
				WHERE T1.STIME BETWEEN TO_CHAR(TO_DATE(#{searchYmd} , 'YYYYMMDD'),'YYYY/MM/DD HH24:MI:SS') AND TO_CHAR(TO_DATE(#{searchYmd} || '235959','YYYYMMDDHH24MISS'),'YYYY/MM/DD HH24:MI:SS')  
				AND T1.RCODE != '1'
				AND (T2.DEPT_NO = (SELECT MAX(T2.DEPT_NO) FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId})
				OR 'Y' = (SELECT COALESCE(MAX(CASE WHEN T2.DEPT_NO = 1 THEN 'Y' ELSE T2.DATA_ALL_YN END), 'N')
							FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId} ) )
				GROUP BY T3.STEP1 ) TT1
  		INNER JOIN NEO_CD TT2 ON TT2.CD_GRP = 'C035' AND TT2.UILANG = '000' AND TT1.SEND_RCODE = TT2.CD 
  		GROUP BY TT1.SEND_RCODE, TT2.CD_NM
  	]]>	
	</select>
	
	<!-- EMS 메인화면 일별 도메인별 -->
	<select id="getDayMailDomain" parameterType="emsMainVO" resultType="emsMainVO">
	<![CDATA[
		SELECT A.CUST_DOMAIN
			 , SUM(A.SEND_AR_AMT) AS CNT_TOT
		FROM NEO_AR_DOMAINLOG A
		INNER JOIN NEO_SUBTASK B ON A.TASK_NO = B.TASK_NO AND A.SUB_TASK_NO = B.SUB_TASK_NO AND COALESCE(B.SEND_TEST_YN, 'N') <> 'Y' 
		INNER JOIN NEO_TASK C ON A.TASK_NO = C.TASK_NO
		WHERE A.SEND_DAY = #{searchYmd} 
		AND COALESCE(A.CUST_DOMAIN, 'X') LIKE '%.%' 
		AND (C.DEPT_NO = (SELECT MAX(T2.DEPT_NO) FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId})
		OR 'Y' = (SELECT COALESCE(MAX(CASE WHEN T2.DEPT_NO = 1 THEN 'Y' ELSE T2.DATA_ALL_YN END), 'N') 
					FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId} ) ) 
		GROUP BY A.CUST_DOMAIN
		ORDER BY 2 DESC
	]]>
	</select>
	
	<!-- EMS 메인화면 일별 캠폐인별 -->
	<select id="getDayMailCampain" parameterType="emsMainVO" resultType="emsMainVO">
	<![CDATA[
		SELECT TT1.CAMP_NO
			 , TT1.CAMP_NM
			 , TT1.CNT_TOT
		FROM ( SELECT A.CAMP_NO
					, MAX(C.CAMP_NM) AS CAMP_NM
					, COUNT(DISTINCT TO_CHAR(A.TASK_NO, '0000000000000000009') || TO_CHAR(A.SUB_TASK_NO , '0000000000000000009')) AS CNT_TASK
					, SUM(A.SEND_AR_AMT) AS CNT_TOT
					, SUM(CASE WHEN A.SEND_RCODE = '000' THEN A.SEND_AR_AMT ELSE 0 END) AS CNT_SUCC
					, SUM(CASE WHEN A.SEND_RCODE != '000' THEN A.SEND_AR_AMT ELSE 0 END) AS CNT_FAIL
				FROM NEO_AR_SENDLOG A
				INNER JOIN NEO_SUBTASK B ON A.TASK_NO = B.TASK_NO AND A.SUB_TASK_NO = B.SUB_TASK_NO AND COALESCE(B.SEND_TEST_YN, 'N') <> 'Y'  
				INNER JOIN NEO_CAMPAIGN C ON A.CAMP_NO = C.CAMP_NO
				WHERE A.SEND_DT BETWEEN #{searchYmd} || '0000' AND #{searchYmd} || '2359' 
				AND (A.DEPT_NO = (SELECT MAX(T2.DEPT_NO) FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId})  
				OR 'Y' = (SELECT COALESCE(MAX(CASE WHEN T2.DEPT_NO = 1 THEN 'Y' ELSE T2.DATA_ALL_YN END), 'N') 
							FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId} ) ) 
				GROUP BY A.CAMP_NO 
				UNION ALL
				SELECT T1.TID
					 , MAX(T3.TNM) AS CAMP_NM  
					 , COUNT(DISTINCT T1.TID ) AS TASK_CNT
					 , COUNT(DISTINCT TO_CHAR(T1.MID, '00000000000000000009') || TO_CHAR(T1.SUBID, '00000000000000000009')  || T1.RID || T1.STIME ) AS TOT
					 , COUNT(DISTINCT CASE WHEN T1.RCODE = '1' THEN TO_CHAR(T1.MID, '00000000000000000009') || TO_CHAR(T1.SUBID, '00000000000000000009')  || T1.RID || T1.STIME END ) AS SUCC
					 , COUNT(DISTINCT CASE WHEN T1.RCODE != '1' THEN TO_CHAR(T1.MID, '00000000000000000009') || TO_CHAR(T1.SUBID, '00000000000000000009')  || T1.RID || T1.STIME END ) AS FAIL
				FROM TS_RESULTLOG T1
				INNER JOIN TS_MAILQUEUE T2 ON T1.MID = T2.MID AND T1.SUBID = T2.SUBID
				INNER JOIN TS_SERVICETYP T3 ON T1.TID = T3.TID
				WHERE T1.STIME BETWEEN TO_CHAR(TO_DATE(#{searchYmd},'YYYYMMDD'),'YYYY/MM/DD HH24:MI:SS') AND TO_CHAR(TO_DATE(#{searchYmd} || '235959','YYYYMMDDHH24MISS'),'YYYY/MM/DD HH24:MI:SS')
				AND (T2.DEPT_NO = (SELECT MAX(T2.DEPT_NO) FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId})
				OR 'Y' = (SELECT COALESCE(MAX(CASE WHEN T2.DEPT_NO = 1 THEN 'Y' ELSE T2.DATA_ALL_YN END), 'N')
							FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId} ) )
				GROUP BY T1.TID ) TT1
 		ORDER BY TT1.CNT_TOT DESC
 	]]>
	</select>
	
	<!-- EMS 메인화면 발송현황 일별  -->
	<select id="getMailSendInfoDay" parameterType="emsMainVO" resultType="emsMainVO">
	<![CDATA[
		SELECT AA.TIMES
			 , SUM(AA.TASK_CNT) AS CNT_TASK
			 , SUM(AA.TOT)      AS CNT_TOT
			 , SUM(AA.SUCC)     AS CNT_SUCC
			 , SUM(AA.FAIL)     AS CNT_FAIL
		FROM ( SELECT SUBSTR(A.SEND_DT,9,2) AS TIMES  
					, COUNT(DISTINCT TO_CHAR(A.TASK_NO, '0000000000000000009') || TO_CHAR(A.SUB_TASK_NO , '0000000000000000009')) AS TASK_CNT
					, SUM(SEND_AR_AMT) AS TOT
					, SUM(CASE WHEN SEND_RCODE = '000' THEN SEND_AR_AMT ELSE 0 END) AS SUCC
					, SUM(CASE WHEN SEND_RCODE <> '000' THEN SEND_AR_AMT ELSE 0 END) AS FAIL
				FROM NEO_AR_SENDLOG A
				INNER JOIN NEO_SUBTASK B ON A.TASK_NO = B.TASK_NO AND A.SUB_TASK_NO = B.SUB_TASK_NO AND COALESCE(B.SEND_TEST_YN, 'N') <> 'Y'
				WHERE A.SEND_DT BETWEEN #{searchYmd} || '0000' AND #{searchYmd} || '2359'
				AND (A.DEPT_NO = (SELECT MAX(T2.DEPT_NO) FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId})  
				OR 'Y' = (SELECT COALESCE(MAX(CASE WHEN T2.DEPT_NO = 1 THEN 'Y' ELSE T2.DATA_ALL_YN END), 'N') 
							FROM NEO_USER T1 INNER JOIN NEO_DEPT T2 ON T1.DEPT_NO = T2.DEPT_NO WHERE T1.USER_ID = #{userId} ) )
				GROUP BY SUBSTR(A.SEND_DT,9,2)
				UNION ALL
				SELECT SUBSTR(T1.STIME,12,2) AS TIMES
					 , COUNT(DISTINCT T1.TID) AS TASK_CNT
					 , COUNT(DISTINCT TO_CHAR(T1.MID, '00000000000000000009') || TO_CHAR(T1.SUBID, '00000000000000000009')  || T1.RID || T1.STIME ) AS TOT
					 , COUNT(DISTINCT CASE WHEN T1.RCODE = '1' THEN TO_CHAR(T1.MID, '00000000000000000009') || TO_CHAR(T1.SUBID, '00000000000000000009')  || T1.RID || T1.STIME END ) AS SUCC
					 , COUNT(DISTINCT CASE WHEN T1.RCODE != '1' THEN TO_CHAR(T1.MID, '00000000000000000009') || TO_CHAR(T1.SUBID, '00000000000000000009')  || T1.RID || T1.STIME END ) AS FAIL
				FROM TS_RESULTLOG T1
				INNER JOIN TS_MAILQUEUE T2 ON T1.MID = T2.MID AND T1.SUBID = T2.SUBID
				WHERE T1.STIME BETWEEN TO_CHAR(TO_DATE(#{searchYmd},'YYYYMMDD'),'YYYY/MM/DD HH24:MI:SS') AND TO_CHAR(TO_DATE(#{searchYmd} || '235959','YYYYMMDDHH24MISS'),'YYYY/MM/DD HH24:MI:SS') 
				AND T2.DEPT_NO = (SELECT TT2.DEPT_NO FROM NEO_USER TT1 INNER JOIN NEO_DEPT TT2 ON TT1.DEPT_NO = TT2.DEPT_NO WHERE TT1.USER_ID = #{userId})
				GROUP BY SUBSTR(T1.STIME,12,2)
				UNION ALL
				SELECT TT1.TIMES, 0, 0, 0 ,0
				  FROM 
				   ( 
					SELECT '00' AS TIMES UNION ALL
					SELECT '01' AS TIMES UNION ALL
					SELECT '02' AS TIMES UNION ALL
					SELECT '03' AS TIMES UNION ALL
					SELECT '04' AS TIMES UNION ALL
					SELECT '05' AS TIMES UNION ALL
					SELECT '06' AS TIMES UNION ALL
					SELECT '07' AS TIMES UNION ALL
					SELECT '08' AS TIMES UNION ALL
					SELECT '10' AS TIMES UNION ALL
					SELECT '11' AS TIMES UNION ALL
					SELECT '12' AS TIMES UNION ALL
					SELECT '13' AS TIMES UNION ALL
					SELECT '14' AS TIMES UNION ALL
					SELECT '15' AS TIMES UNION ALL
					SELECT '16' AS TIMES UNION ALL
					SELECT '17' AS TIMES UNION ALL
					SELECT '18' AS TIMES UNION ALL
					SELECT '19' AS TIMES UNION ALL
					SELECT '20' AS TIMES UNION ALL
					SELECT '21' AS TIMES UNION ALL
					SELECT '22' AS TIMES UNION ALL
					SELECT '23' AS TIMES  
				   ) TT1
			) AA
		WHERE AA.TIMES <= (CASE WHEN #{searchYmd}  < TO_CHAR(NOW() , 'YYYYMMDD') THEN '23' ELSE TO_CHAR(NOW() , 'HH24') END) 
		GROUP BY AA.TIMES
		ORDER BY AA.TIMES
  	]]>
	</select>
	
	<!-- EMS 메인화면 발송현황 월별 -->
	<select id="getMailSendInfoMons" parameterType="emsMainVO" resultType="emsMainVO">
	<![CDATA[
		SELECT AA.DAYS
			 , SUM(AA.TASK_CNT) AS TASK_CNT
			 , SUM(AA.TOT)      AS TOT
			 , SUM(AA.SUCC)     AS SUCC
			 , SUM(AA.FAIL)     AS FAIL
		FROM ( SELECT SUBSTR(A.SEND_DT,7,2) AS DAYS
					, COUNT(DISTINCT TO_CHAR(A.TASK_NO, '0000000000000000009') || TO_CHAR(A.SUB_TASK_NO , '0000000000000000009')) AS TASK_CNT
					, SUM(SEND_AR_AMT) AS TOT
					, SUM(CASE WHEN SEND_RCODE = '000' THEN SEND_AR_AMT ELSE 0 END) AS SUCC
					, SUM(CASE WHEN SEND_RCODE <> '000' THEN SEND_AR_AMT ELSE 0 END) AS FAIL
				FROM NEO_AR_SENDLOG A
				INNER JOIN NEO_SUBTASK B ON A.TASK_NO = B.TASK_NO AND A.SUB_TASK_NO = B.SUB_TASK_NO AND COALESCE(B.SEND_TEST_YN, 'N') <> 'Y'
				WHERE A.SEND_DT BETWEEN #{searchYm} || '010000' AND #{searchYm} || '312359' 
				AND A.DEPT_NO = (SELECT TT2.DEPT_NO FROM NEO_USER TT1 INNER JOIN NEO_DEPT TT2 ON TT1.DEPT_NO = TT2.DEPT_NO WHERE TT1.USER_ID = #{userId})
				GROUP BY SUBSTR(A.SEND_DT,7,2)
				UNION ALL
				SELECT SUBSTR(T1.STIME,9,2) AS DAYS
					 , COUNT(DISTINCT T1.TID) AS TASK_CNT
					 , COUNT(DISTINCT TO_CHAR(T1.MID, '00000000000000000009') || TO_CHAR(T1.SUBID, '00000000000000000009')  || T1.RID || T1.STIME ) AS TOT
					 , COUNT(DISTINCT CASE WHEN T1.RCODE = '1' THEN TO_CHAR(T1.MID, '00000000000000000009') || TO_CHAR(T1.SUBID, '00000000000000000009')  || T1.RID || T1.STIME END ) AS SUCC
					 , COUNT(DISTINCT CASE WHEN T1.RCODE != '1' THEN TO_CHAR(T1.MID, '00000000000000000009') || TO_CHAR(T1.SUBID, '00000000000000000009')  || T1.RID || T1.STIME END ) AS FAIL
				FROM TS_RESULTLOG T1
				INNER JOIN TS_MAILQUEUE T2 ON T1.MID = T2.MID AND T1.SUBID = T2.SUBID
				WHERE T1.STIME BETWEEN TO_CHAR(TO_DATE(#{searchYm} || '01' ,'YYYYMMDD'),'YYYY/MM/DD HH24:MI:SS') AND
					 (TO_CHAR(NEO_LAST_DAY(#{searchYm} || '01' ), 'YYYY/MM/DD') || ' 23:59:59') 
				AND T2.DEPT_NO = (SELECT TT2.DEPT_NO FROM NEO_USER TT1 INNER JOIN NEO_DEPT TT2 ON TT1.DEPT_NO = TT2.DEPT_NO WHERE TT1.USER_ID = #{userId})
				GROUP BY SUBSTR(T1.STIME,9,2)
		) AA
		WHERE AA.DAYS <= (CASE WHEN #{searchYm} < TO_CHAR(NOW() , 'YYYYMM') THEN '99' ELSE TO_CHAR(NOW() , 'DD') END) 
  		GROUP BY AA.DAYS
  		ORDER BY 1 
  	]]>	
	</select>
	
	<!-- EMS 메인화면 일별 발송 일정  -->
	<select id="getDayMailSendSch" parameterType="emsMainVO" resultType="emsMainVO">
	<![CDATA[	
	SELECT *
	FROM (
		SELECT SUBSTR(T2.SEND_DT,9,2) || ':' || SUBSTR(T2.SEND_DT,11,2) AS SEND_HH24MI
			 , T1.TASK_NM
			 , T1.SEND_MODE
			 , T7.CD_NM AS SEND_MODE_NM
			 , T6.CAMP_NM
			 , T1.SEG_NO
			 , T3.SEG_NM
			 , COALESCE(T5.USER_NM, T1.USER_ID) AS USER_NM 
			 , T4.CD_NM AS WORK_STATUS_NM
			 , (CASE WHEN T1.PROHIBIT_CHK_TYP = '002' THEN '해당' END) AS COMPLIANCD_YN
			 , T2.WORK_STATUS 
			 , T2.TASK_NO
			 , T2.SUB_TASK_NO
			 , ROW_NUMBER() OVER (ORDER BY T2.SEND_DT DESC) SEQ
			 , COUNT(1) OVER() TOTAL_COUNT
		FROM NEO_SUBTASK T2  
		INNER JOIN NEO_TASK T1 ON T1.TASK_NO = T2.TASK_NO 
		INNER JOIN NEO_CD T7 ON T7.CD_GRP = 'C017' AND T1.SEND_MODE = T7.CD AND T7.UILANG = '000'
		INNER JOIN NEO_SEGMENT T3 ON T1.SEG_NO = T3.SEG_NO
		INNER JOIN NEO_CD T4 ON T4.CD_GRP = 'C101' AND T2.WORK_STATUS = T4.CD AND T4.UILANG = '000'
		INNER JOIN NEO_USER T5 ON T1.USER_ID = T5.USER_ID
		INNER JOIN NEO_CAMPAIGN T6 ON T1.CAMP_NO = T6.CAMP_NO
		WHERE T2.WORK_STATUS NOT IN ('000')
		AND COALESCE(T2.STATUS, '000') IN ('000','001')
		AND T2.SEND_DT BETWEEN #{searchBoardDt} || '0000' AND #{searchBoardDt} || '2359'
		AND T2.RTY_TYP = '000'
		AND T2.SEND_DT <= TO_CHAR(NOW(), 'YYYYMMDDHH24MI' )
		AND T1.DEPT_NO = (SELECT COALESCE(T1.DEPT_NO, '-1') FROM NEO_USER WHERE USER_ID = #{userId})
	) TT
	WHERE SEQ BETWEEN (#{page}-1)*#{rows}+1 AND #{page}*#{rows}	
  	]]>
	</select>
	
	<!-- EMS 메인화면 일별 발송 일정  -->
	<select id="getUserMenu" parameterType="emsMainVO" resultType="emsMainVO">
	<![CDATA[	
		SELECT C.SERVICE_GB , E.CD_NM , C.MENU_ID AS PMENU_ID , C.MENU_NM AS PMENU_NM , B.MENU_ID   , B.MENU_NM  , B.SOURCE_PATH ,A.QMENU_YN
		  FROM NEO_MENUUSER_MAPP A 
		  INNER JOIN  NEO_SYSMENU B ON A.MENU_ID = B.MENU_ID 
		  INNER JOIN  NEO_SYSMENU C ON B.PARENTMENU_ID = C.MENU_ID 
		  INNER JOIN  NEO_USER_PROG D ON C.SERVICE_GB = D.PROG_ID AND A.USER_ID = D.USER_ID 
		  INNER JOIN NEO_CD E ON D.PROG_ID = CAST(E.CD AS INTEGER) AND E.CD_GRP = 'C111'
		 WHERE A.USER_ID = #{userId} 
		 ORDER BY  C.SERVICE_GB , C.SORT_SNO , B.SORT_SNO 
  	]]>
	</select>
	
	<!-- EMS 메인화면 퀵메뉴 삭제  -->
	<update id="deleteMainQuickMenu" parameterType="emsMainVO">
		UPDATE NEO_MENUUSER_MAPP SET QMENU_YN ='N' WHERE MENU_ID = #{qmenuYn} AND USER_ID = #{userId}  
	</update>
	
	<update id="deleteAllMainQuickMenu" parameterType="emsMainVO">
		UPDATE NEO_MENUUSER_MAPP SET QMENU_YN ='N' WHERE USER_ID = #{userId}  
	</update>
	
	<!-- EMS 메인화면 퀵메뉴 저장  -->
	<update id="insertMainQuickMenu" parameterType="emsMainVO">
		UPDATE NEO_MENUUSER_MAPP 
		   SET QMENU_YN ='Y' 
		 WHERE USER_ID = #{userId} 
		  AND MENU_ID IN 
		 <foreach collection="arrDelQmenu" item="item" index="index" open="(" close=")" separator=",">
		#{item}
		</foreach>
	</update>
</mapper>